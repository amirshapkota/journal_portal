# Leaderboard Empty Array Issue - Solution

## Problem

The leaderboard API was returning an empty array even though there was submission data in the database. The leaderboard worked on another PC but not on this one.

## Root Cause

The leaderboard data is **not automatically populated** when submissions are created. Instead, it requires running a Celery task called `update_leaderboards` which:

- Calculates rankings for reviewers based on completed reviews
- Calculates rankings for authors based on accepted/published submissions
- Only includes data from the **current year**

The leaderboard was empty because the task had never been run on this system.

## Solution Applied

The `update_leaderboards()` task was manually executed, which successfully created:

- 2 reviewer leaderboard entries (from completed reviews)
- 100 author leaderboard entries (from accepted/published submissions)
- Total: 102 leaderboard entries

## How to Update Leaderboards in the Future

### Option 1: Management Command (Recommended)

```bash
cd backend-journal-portal
python manage.py update_leaderboards
```

### Option 2: Django Admin Interface

1. Go to Django Admin: http://localhost:8000/admin/
2. Navigate to: Achievements → Leaderboards
3. Select any leaderboard entry (or select all)
4. From "Actions" dropdown, select "Update all leaderboards (recalculate rankings)"
5. Click "Go"

### Option 3: API Endpoint (Admin Only)

```bash
POST /api/achievements/leaderboards/update_leaderboards/
Authorization: Bearer <admin-token>
```

Response:

```json
{
  "message": "Leaderboards updated successfully",
  "result": {
    "reviewer_leaderboards": 2,
    "author_leaderboards": 100,
    "total": 102
  }
}
```

### Option 4: Django Shell

```bash
cd backend-journal-portal
python manage.py shell
```

```python
from apps.achievements.tasks import update_leaderboards
result = update_leaderboards()
print(result)
```

## Automatic Updates

The leaderboard is configured to update automatically via Celery Beat:

- Task: `apps.achievements.tasks.update_leaderboards`
- Schedule: Daily
- Configuration: `journal_portal/settings.py` → `CELERY_BEAT_SCHEDULE`

**Note:** For automatic updates to work, you must have:

1. Celery worker running
2. Celery beat scheduler running

To start Celery services:

```bash
# In one terminal - Start Celery worker
celery -A journal_portal worker -l info

# In another terminal - Start Celery beat
celery -A journal_portal beat -l info
```

## Why This Issue Occurred on One PC but Not Another

The other PC likely had:

1. The Celery worker and beat scheduler running continuously
2. The leaderboard task had been manually run before
3. The leaderboard was populated when the system was first set up

This PC probably:

1. Never had the Celery services running
2. Never manually triggered the leaderboard update
3. Was a fresh setup without initial data population

## Leaderboard Calculation Logic

### Reviewer Leaderboard

- Based on completed reviews in the current year
- Score: `reviews_count × 10`
- Top 100 reviewers ranked by review count

### Author Leaderboard

- Based on accepted/published submissions in the current year
- Score: `publications_count × 20`
- Top 100 authors ranked by publication count

### Period Types

- `YEARLY`: Current calendar year (Jan 1 - Dec 31)
- `MONTHLY`: Current month
- `QUARTERLY`: Current quarter
- `ALL_TIME`: All historical data

**Current Implementation:** Only `YEARLY` period is generated by the task.

## Verification Commands

Check leaderboard status:

```bash
python manage.py shell -c "from apps.achievements.models import Leaderboard; print(f'Total: {Leaderboard.objects.count()}'); print(f'Reviewers: {Leaderboard.objects.filter(category=\"REVIEWER\").count()}'); print(f'Authors: {Leaderboard.objects.filter(category=\"AUTHOR\").count()}')"
```

Check available data:

```bash
python manage.py shell -c "from apps.reviews.models import ReviewAssignment; from apps.submissions.models import Submission; from django.utils import timezone; current_year = timezone.now().year; print(f'Completed reviews this year: {ReviewAssignment.objects.filter(status=\"COMPLETED\", completed_at__year=current_year).count()}'); print(f'Accepted/Published submissions this year: {Submission.objects.filter(status__in=[\"ACCEPTED\", \"PUBLISHED\"], created_at__year=current_year).count()}')"
```

## New Files Created

1. `apps/achievements/management/commands/update_leaderboards.py` - Management command
2. Admin action added to `LeaderboardAdmin`
3. API endpoint added: `POST /api/achievements/leaderboards/update_leaderboards/`

## Date: December 24, 2025
